<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Cookie Sniffer 功能测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .test-button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .test-button:hover {
            background: #0056b3;
        }
        .result {
            margin-top: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 4px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        .feature-list {
            background: #e7f3ff;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
        }
        .feature-list h4 {
            margin-top: 0;
            color: #0056b3;
        }
        .feature-list ul {
            margin: 10px 0;
            padding-left: 20px;
        }
        .feature-list li {
            margin: 5px 0;
        }
    </style>
</head>
<body>
    <h1>🍪 Cookie Sniffer 功能测试</h1>
    
    <div class="feature-list">
        <h4>🎉 新增功能</h4>
        <ul>
            <li><strong>实时输入记忆</strong>: 设置界面填写的内容会实时保存，重新打开后自动恢复</li>
            <li><strong>快捷规则按钮</strong>: 在主页面上显示有URL的规则快捷按钮，点击直接打开对应网页</li>
            <li><strong>改进的导入功能</strong>: 修复了消息端口关闭问题，添加了超时机制</li>
        </ul>
    </div>
    
    <div class="test-section">
        <h3>测试JSON数据</h3>
        <p>使用以下JSON数据测试导入功能：</p>
        <div class="result" id="testJson">
{
  "version": "1.0",
  "exportTime": "2024-01-01T12:00:00.000Z",
  "rules": [
    {
      "key": "百度搜索",
      "value": "baidu.com",
      "type": "关键词",
      "url": "https://www.baidu.com"
    },
    {
      "key": "GitHub",
      "value": "github.com",
      "type": "关键词",
      "url": "https://github.com"
    },
    {
      "key": "Google",
      "value": "google.com",
      "type": "关键词",
      "url": "https://www.google.com"
    }
  ]
}
        </div>
        <button class="test-button" onclick="copyTestJson()">复制测试JSON</button>
    </div>

    <div class="test-section">
        <h3>功能测试步骤</h3>
        <ol>
            <li><strong>实时输入记忆测试</strong>:
                <ul>
                    <li>打开Cookie Sniffer扩展</li>
                    <li>点击设置按钮(⚙️)</li>
                    <li>在规则输入框中填写内容（不要点击添加）</li>
                    <li>关闭设置弹窗，重新打开</li>
                    <li>检查输入内容是否已保存</li>
                </ul>
            </li>
            <li><strong>快捷规则按钮测试</strong>:
                <ul>
                    <li>导入包含URL的规则（使用上面的测试数据）</li>
                    <li>检查主页面是否显示快捷按钮</li>
                    <li>点击快捷按钮，检查是否能打开对应网页</li>
                </ul>
            </li>
            <li><strong>导入功能测试</strong>:
                <ul>
                    <li>点击"导入规则"按钮</li>
                    <li>选择文件或粘贴JSON内容</li>
                    <li>点击"确认导入"按钮</li>
                    <li>检查是否成功导入并显示快捷按钮</li>
                </ul>
            </li>
        </ol>
    </div>

    <div class="test-section">
        <h3>故障排除</h3>
        <ul>
            <li>确保扩展已正确安装并重新加载</li>
            <li>检查浏览器控制台是否有错误信息</li>
            <li>确认JSON格式正确</li>
            <li>检查按钮是否可以被点击</li>
            <li>查看background script的日志输出</li>
            <li>检查消息端口是否正常连接</li>
            <li>验证快捷按钮是否正确显示有URL的规则</li>
        </ul>
    </div>

    <div class="test-section">
        <h3>调试信息</h3>
        <div id="debugInfo" class="result"></div>
        <button class="test-button" onclick="checkExtension()">检查扩展状态</button>
        <button class="test-button" onclick="testImport()">测试导入功能</button>
        <button class="test-button" onclick="testQuickButtons()">测试快捷按钮</button>
        <button class="test-button" onclick="clearDebug()">清空调试信息</button>
    </div>

    <script>
        function copyTestJson() {
            const testJson = document.getElementById('testJson').textContent;
            navigator.clipboard.writeText(testJson).then(() => {
                alert('测试JSON已复制到剪贴板！');
            }).catch(() => {
                alert('复制失败，请手动复制');
            });
        }

        function checkExtension() {
            const debugInfo = document.getElementById('debugInfo');
            debugInfo.textContent = '检查扩展状态...\n';
            
            if (typeof chrome !== 'undefined' && chrome.runtime) {
                debugInfo.textContent += '✅ Chrome扩展API可用\n';
                
                try {
                    chrome.runtime.sendMessage({ type: "getMatchRules" }, function(response) {
                        if (chrome.runtime.lastError) {
                            debugInfo.textContent += `❌ 扩展通信错误: ${chrome.runtime.lastError.message}\n`;
                        } else if (response) {
                            const rulesWithUrl = response.rules ? response.rules.filter(rule => rule.url && rule.url.trim() !== "") : [];
                            debugInfo.textContent += `✅ 扩展响应正常，当前规则数量: ${response.rules ? response.rules.length : 0}\n`;
                            debugInfo.textContent += `✅ 有URL的规则数量: ${rulesWithUrl.length}\n`;
                            if (rulesWithUrl.length > 0) {
                                debugInfo.textContent += `✅ 快捷按钮应该显示: ${rulesWithUrl.map(r => r.key).join(', ')}\n`;
                            }
                        } else {
                            debugInfo.textContent += '❌ 扩展没有响应\n';
                        }
                    });
                } catch (error) {
                    debugInfo.textContent += `❌ 发送消息失败: ${error.message}\n`;
                }
            } else {
                debugInfo.textContent += '❌ Chrome扩展API不可用\n';
            }
        }

        function testImport() {
            const debugInfo = document.getElementById('debugInfo');
            const testData = {
                version: "1.0",
                exportTime: new Date().toISOString(),
                rules: [
                    {
                        key: "测试规则1",
                        value: "/test1/",
                        type: "关键词",
                        url: "https://example1.com"
                    },
                    {
                        key: "测试规则2",
                        value: "/test2/",
                        type: "关键词",
                        url: "https://example2.com"
                    }
                ]
            };

            debugInfo.textContent += '\n开始测试导入功能...\n';
            debugInfo.textContent += `测试数据: ${JSON.stringify(testData, null, 2)}\n`;

            const timeout = setTimeout(() => {
                debugInfo.textContent += '❌ 测试导入超时\n';
            }, 10000);

            chrome.runtime.sendMessage({ 
                type: "importRules", 
                rules: testData.rules 
            }, function(response) {
                clearTimeout(timeout);
                
                if (chrome.runtime.lastError) {
                    debugInfo.textContent += `❌ 导入测试失败: ${chrome.runtime.lastError.message}\n`;
                } else if (response) {
                    debugInfo.textContent += `✅ 导入测试成功: ${JSON.stringify(response)}\n`;
                    debugInfo.textContent += `✅ 导入后应该显示2个快捷按钮\n`;
                } else {
                    debugInfo.textContent += '❌ 导入测试没有响应\n';
                }
            });
        }

        function testQuickButtons() {
            const debugInfo = document.getElementById('debugInfo');
            debugInfo.textContent += '\n测试快捷按钮功能...\n';
            
            chrome.runtime.sendMessage({ type: "getMatchRules" }, function(response) {
                if (response && response.rules) {
                    const rulesWithUrl = response.rules.filter(rule => rule.url && rule.url.trim() !== "");
                    debugInfo.textContent += `当前有URL的规则: ${rulesWithUrl.length} 个\n`;
                    
                    if (rulesWithUrl.length > 0) {
                        debugInfo.textContent += `快捷按钮应该显示:\n`;
                        rulesWithUrl.forEach(rule => {
                            debugInfo.textContent += `  - ${rule.key} -> ${rule.url}\n`;
                        });
                        debugInfo.textContent += `\n点击快捷按钮应该能打开对应网页\n`;
                    } else {
                        debugInfo.textContent += `没有有URL的规则，不会显示快捷按钮\n`;
                    }
                } else {
                    debugInfo.textContent += `❌ 无法获取规则信息\n`;
                }
            });
        }

        function clearDebug() {
            document.getElementById('debugInfo').textContent = '';
        }
    </script>
</body>
</html>
